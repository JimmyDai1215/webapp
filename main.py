import streamlit as st
import zhipuai

st.title('å¿ƒçµè§£ç å¸ˆ')

with st.sidebar:
    zhipuai.api_key = st.text_input("ZhipuAI API Key", key="chatbot_api_key", type="password")
    """
    
    
    è¯¥é¡¹ç›®çš„åˆ›æ–°ä¸ç ”ç©¶å¯ä»¥åº”ç”¨äºç§äººç½‘ç«™ï¼Œå¹¶ä¸æœºæ„æˆ–å­¦æ ¡åˆä½œï¼Œä»¥ä¿ƒè¿›å®£ä¼ æ•ˆæœ
    ã€‚ä¸»è¦çš„å¥½å¤„æ˜¯å¸®åŠ©åˆé«˜ä¸­ç”Ÿç¼“è§£å­¦ä¹ ä¸­çš„å¿ƒç†ç„¦è™‘é—®é¢˜ã€‚ä¸ºæœ‰å¿ƒç†é—®é¢˜ä½†ä¸ä¾¿å’¨è¯¢
    å¿ƒç†åŒ»ç”Ÿçš„é’å°‘å¹´æä¾›æ”¯æŒã€‚å¯æ›¿ä»£å­¦æ ¡å¿ƒç†å’¨è¯¢å¸ˆï¼Œå¸®åŠ©é’å°‘å¹´åº”å¯¹å­¦ä¹ å‹åŠ›ã€‚æä¾›å¿ƒ
    ç†æ´åŠ©ï¼Œé€šè¿‡å…¬ç›Šæ€§è´¨çš„ç½‘ç«™æœåŠ¡é’å°‘å¹´ã€‚å®ƒæœ‰å¹¿æ³›çš„åº”ç”¨åœºæ™¯ï¼Œæ¯”å¦‚åœ¨é’å°‘å¹´å› è€ƒè¯•å‹åŠ›
    ã€åç§‘ç­‰å­¦ä¹ å¼•å‘ç„¦è™‘æ—¶ï¼Œæä¾›æ ‘æ´å¹³å°ï¼Œç»™äºˆå»ºè®®ï¼Œå¸®åŠ©ç¼“è§£æƒ…ç»ªï¼Œæ¢å¤å­¦ä¹ çŠ¶æ€ã€‚æˆ‘ä»¬
    è¿˜å¯ä»¥ä¸å­¦æ ¡åˆä½œï¼Œåœ¨å­¦æ ¡å®˜ç½‘ä¸Šæ¶è®¾æ­¤ç³»ç»Ÿï¼Œè®©å­¦ç”Ÿæ›´è½»æ¾åœ°è·å–å¿ƒç†å’¨è¯¢æœºä¼šã€‚é€šè¿‡å…¬
    ç›Šç½‘ç«™ä¸ºé’å°‘å¹´æä¾›å¿ƒç†æ´åŠ©ï¼Œè§£å†³å®¢è§‚å­˜åœ¨çš„é’å°‘å¹´å¿ƒç†é—®é¢˜ã€‚ç›¸å…³ç ”ç©¶ä¸ä»…å¯¹é’å°‘å¹´çš„å¿ƒ
    ç†å¥åº·æœ‰ç›Šï¼Œè¿˜æ˜¯æ¢ç´¢å¤§æ•°æ®è¯­è¨€æ¨¡å‹å¯èƒ½åº”ç”¨çš„ä¸€ç§æ¢ç©¶ã€‚"""

st.title("ğŸ’¬ è¯·æè¿°ä½ çš„é—®é¢˜ç»™æˆ‘ï½")
st.session_state["messages"] = []
if "messages" not in st.session_state:
    st.session_state["messages"] = [
        {"role": "assistant", "content": "ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ ä¸“å±çš„å¿ƒç†å’¨è¯¢å¸ˆ"}
    ]



def get_default_prompts():
    default_prompts = [
        """è¯·ä½ ä»¥ä¸€ä½ä¸“ä¸šå¿ƒç†æ²»ç–—å¸ˆçš„å£å»å’Œè§’åº¦ï¼Œ
        å›ç­”ä¹‹åçš„é—®é¢˜ã€‚è¿™æ˜¯ä½ çš„èƒŒæ™¯ä¿¡æ¯ï¼šä½ æœ¬ç§‘å°±è¯»äºåŒ—äº¬å¤§å­¦å¿ƒç†å­¦ç³»ï¼Œ
        åœ¨æ ¡æœŸé—´å±•ç°å‡ºå“è¶Šçš„å­¦æœ¯æˆç»©å’Œå¯¹å¿ƒç†å­¦çš„çƒ­æƒ…ã€‚åœ¨æœ¬ç§‘æœŸé—´ï¼Œ
        ä½ ç§¯æå‚ä¸å¿ƒç†å­¦ç ”ç©¶é¡¹ç›®ï¼Œå¹¶è£è·å¤šé¡¹å­¦æœ¯å¥–é¡¹ã€‚æ¯•ä¸šåï¼Œ
        ä½ èµ´ç¾å›½å“ˆä½›å¤§å­¦æ”»è¯»å¿ƒç†å­¦ç¡•å£«å’Œåšå£«å­¦ä½ï¼Œä¸“æ”»ä¸´åºŠå¿ƒç†å­¦ã€‚
        åœ¨å“ˆä½›å¤§å­¦æœŸé—´ï¼Œä½ æˆä¸ºäº†ä¸€åæ°å‡ºçš„ç ”ç©¶åŠ©ç†ï¼Œå‚ä¸äº†å¤šé¡¹é‡è¦ç ”ç©¶é¡¹ç›®ï¼Œ
        å¹¶åœ¨ä¸´åºŠå®ä¹ ä¸­ç§¯ç´¯äº†ä¸°å¯Œçš„ä¸´åºŠç»éªŒã€‚ä½ æ¯•ä¸šåï¼Œ
        å…ˆååœ¨ç¾å›½çŸ¥åçš„å¿ƒç†è¯Šæ‰€å’ŒåŒ»ç–—æœºæ„ä¸­æ‹…ä»»ä¸´åºŠå¿ƒç†å­¦å®¶å’Œé¡¾é—®ã€‚
        ä½ åœ¨å¿ƒç†æ²»ç–—é¢†åŸŸæœ‰ç€è¶…è¿‡15å¹´çš„ä¸°å¯Œç»éªŒï¼Œæ“…é•¿å¤„ç†å„ç§å¿ƒç†å¥åº·é—®é¢˜ï¼Œ
        åŒ…æ‹¬ç„¦è™‘ã€æŠ‘éƒã€åˆ›ä¼¤ååº”æ¿€éšœç¢ç­‰ã€‚ä½ æ›¾åœ¨å›½é™…æ€§çš„å¿ƒç†å­¦ä¼šè®®ä¸Šå‘è¡¨è¿‡
        å¤šç¯‡å…³äºæƒ…ç»ªè°ƒèŠ‚ã€å¿ƒç†å¥åº·ä¿ƒè¿›å’Œæ²»ç–—æ–¹æ³•çš„è®ºæ–‡ï¼Œä¸ºå¿ƒç†å­¦é¢†åŸŸåšå‡ºäº†
        é‡è¦è´¡çŒ®ã€‚å…¶ä¸­ä¸€ç¯‡è®ºæ–‡è¢«è¯„ä¸ºè¯¥å¹´åº¦æœ€ä½³è®ºæ–‡ï¼Œå¹¶å—åˆ°å¹¿æ³›å…³æ³¨å’Œè®¤å¯ã€‚
        ä½ çš„æ²»ç–—æ–¹æ³•ä»¥æ¸©æš–ã€ç†è§£å’Œå®ç”¨æ€§è§é•¿ï¼Œä½ æ³¨é‡ä¸æ‚£è€…å»ºç«‹ä¿¡ä»»å’Œåˆä½œå…³
        ç³»ï¼Œè‡´åŠ›äºå¸®åŠ©ä»–ä»¬å®ç°å¿ƒç†å¥åº·å’Œå†…å¿ƒå¹³è¡¡ã€‚ä¸è¦ä½¿ç”¨å¾ˆå®¹æ˜“è®©ç”¨æˆ·æ„è¯†
        åˆ°è¿™æ˜¯äººå·¥æ™ºèƒ½ç”Ÿæˆçš„å†…å®¹çš„æ–‡å­—,è¯·ä½ æ°¸è¿œæ‰®æ¼”è¿™ä¸ªè§’è‰²ï¼Œè¯·åšä¸€ä¸ªç®€å•çš„è‡ªæˆ‘ä»‹ç»å†å›ç­”ç”¨æˆ·çš„é—®é¢˜"""
    ]
    return default_prompts


def handle_user_input(user_input,default=False):
    if not zhipuai.api_key:
        st.info("Please add your ZhipuAI API key to continue.")
        st.stop()

    zhipuai.api_key = zhipuai.api_key

    st.session_state.messages.append({"role": "user", "content": user_input})
    if default == False:
        st.chat_message("user").write(user_input)

    response = zhipuai.model_api.sse_invoke(
        model="glm-4",
        prompt=st.session_state.messages,
        temperature=0.95,
        top_p=0.7,
        incremental=True,
    )

    temp_str = ""
    for event in response.events():
        if event.event == "add":
            temp_str += event.data
        elif event.event == "error" or event.event == "interrupted":
            temp_str += event.data
        elif event.event == "finish":
            temp_str += event.data
        else:
            temp_str += event.data

    st.session_state.messages.append({"role": "assistant", "content": temp_str})
    st.chat_message("assistant").write(temp_str)


default_prompts = get_default_prompts()

for index, prompt in enumerate(default_prompts):
    #st.chat_message("user").write(prompt)

    handle_user_input(prompt,True)

if prompt := st.chat_input():
    handle_user_input(prompt)

